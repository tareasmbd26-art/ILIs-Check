<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico Paneles Gamewell-FCI v3.2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 10px;
            color: #334155;
        }

        .container { max-width: 900px; margin: 0 auto; }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-bottom: 5px solid #2563eb;
        }

        .header h1 { color: #1e3a8a; font-size: clamp(1.5rem, 5vw, 2rem); margin-bottom: 8px; }
        .header p { color: #64748b; font-size: clamp(0.9rem, 3vw, 1rem); }

        .disclaimer-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-left: 5px solid #d97706;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s ease; }

        .main-card {
            background: white;
            border-radius: 12px;
            padding: clamp(20px, 5vw, 35px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .step-title { display: flex; align-items: center; margin-bottom: 20px; gap: 10px; }
        .step-title h2 { color: #1e293b; font-size: clamp(1.2rem, 4vw, 1.5rem); }

        .question-box {
            background: #f1f5f9;
            border-left: 4px solid #64748b;
            padding: clamp(15px, 4vw, 25px);
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .question-box p { font-size: clamp(1rem, 3vw, 1.15rem); font-weight: 600; line-height: 1.6; }

        .diagnosis-box { padding: clamp(15px, 4vw, 25px); margin-bottom: 20px; border-radius: 8px; border-left: 5px solid; }
        
        .diagnosis-bad { background: #fef2f2; border-color: #dc2626; }
        .diagnosis-bad h3 { color: #991b1b; }
        .diagnosis-bad p { color: #dc2626; font-weight: 500; }

        .diagnosis-good { background: #ecfdf5; border-color: #059669; }
        .diagnosis-good h3 { color: #065f46; }
        .diagnosis-good p { color: #059669; font-weight: 500; }

        .take-photo {
            display: block;
            margin-top: 10px;
            color: #dc2626;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-top: 1px dashed #fca5a5;
            padding-top: 8px;
        }

        .warning-note {
            background-color: #fff7ed;
            border: 1px solid #fdba74;
            color: #c2410c;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn:active { transform: scale(0.98); }
        .btn-yes { background: #16a34a; color: white; box-shadow: 0 4px 6px rgba(22, 163, 74, 0.2); }
        .btn-yes:hover { background: #15803d; }
        .btn-no { background: #dc2626; color: white; box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2); }
        .btn-no:hover { background: #b91c1c; }
        .btn-neutral { background: #2563eb; color: white; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .btn-neutral:hover { background: #1d4ed8; }

        .nav-buttons { margin-top: auto; display: flex; gap: 10px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .btn-nav { padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; }
        .btn-back { background: #e2e8f0; color: #475569; }
        .btn-reset { background: #334155; color: white; margin-left: auto; }

        .history-container { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; }
        .history-tag { display: inline-block; background: #3b82f6; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; margin: 2px; }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .export-section h3 { color: #1e293b; margin-bottom: 15px; font-size: 1.1rem; }

        .tech-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .tech-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 12px 20px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .btn-export:hover { background: #047857; }

        .btn-export.pdf { background: #dc2626; }
        .btn-export.pdf:hover { background: #b91c1c; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Diagnóstico Paneles Gamewell-FCI</h1>
            <p>Guía Técnica Interactiva | v3.2</p>
        </div>

        <div class="disclaimer-box">
            <svg style="flex-shrink:0" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            <div>
                <strong>NOTA IMPORTANTE PARA EL TÉCNICO:</strong><br>
                Esta herramienta es una guía de apoyo lógica basada en manuales. No sustituye su juicio profesional. Realice las pruebas bajo su propio criterio y normas de seguridad.
            </div>
        </div>

        <div class="progress-container">
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                <span>Progreso</span>
                <span id="stepCounter">Paso 1</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 5%"></div></div>
        </div>

        <div class="main-card">
            <div id="contentArea"></div>
            <div class="nav-buttons" id="navButtons"></div>
        </div>

        <div class="export-section" id="exportSection">
            <h3>Finalizar Diagnóstico - Generar Reporte de Auditoría</h3>
            <p style="color: #64748b; margin-bottom: 15px; font-size: 0.9rem;">
                <strong>ATENCIÓN:</strong> Para exportar el registro de auditoría, debe ingresar su nombre. Este reporte mostrará TODOS los pasos que siguió durante el diagnóstico.
            </p>
            <input type="text" id="techName" class="tech-input" placeholder="Nombre completo del técnico *" required>
            <div class="export-buttons">
                <button class="btn-export pdf" onclick="exportToPDF()" id="exportBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Exportar Registro de Auditoría (PDF)
                </button>
            </div>
            <p style="color: #dc2626; font-size: 0.8rem; margin-top: 10px; font-weight: 600;">
                ADVERTENCIA: Este reporte será revisado por su supervisor para verificar el cumplimiento del procedimiento.
            </p>
        </div>

        <div class="history-container">
            <h3 style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 10px;">Registro de Pasos (Auditoría):</h3>
            <div id="historyTags"></div>
        </div>
    </div>

    <script>
        let auditLog = [];
        let currentStep = 'inicio';
        let history = ['inicio'];
        let canExport = false;

        function logAction(action, details) {
            auditLog.push({
                timestamp: new Date().toLocaleTimeString('es-ES'),
                step: currentStep,
                stepTitle: steps[currentStep].title,
                action: action,
                details: details,
                userChoice: details
            });
        }

        const steps = {
            inicio: {
                title: "Menú Principal",
                question: "¿Qué componente del sistema va a diagnosticar?",
                type: "question",
                options: [
                    { label: "Tarjeta ILI (Lazo/CPU)", next: "ili_start" },
                    { label: "Tarjeta de Voz (VG: VGC/VGX)", next: "vg_select" },
                    { label: "Fuente PM-9", next: "pm9_check" },
                    { label: "Pantallas / LCD", next: "falla_lcd" }
                ]
            },

            ili_start: {
                title: "Estado Inicial ILI",
                question: "¿Los LEDs de la tarjeta ILI están encendidos?",
                type: "question",
                options: [
                    { label: "Sí, están encendidos", next: "tipo_falla_ili" },
                    { label: "No, están apagados", next: "ili_leds_no" }
                ]
            },
            
            tipo_falla_ili: {
                title: "Selección de Falla ILI",
                question: "La ILI está encendida. ¿Cuál es el problema actual?",
                type: "question",
                options: [
                    { label: "Se mantiene Sistema Normal", next: "ili_system_normal" },
                    { label: "No reconoce dispositivos", next: "reconoce_no" },
                    { label: "Ground Fault (Tierra)", next: "gf_start" },
                    { label: "Falla de Red / RPT", next: "rpt_check_leds" },
                    { label: "Los Troubles no se detienen", next: "troubles_continuous" }
                ]
            },

            troubles_continuous: {
                title: "Análisis de Troubles Continuos",
                question: "¿Los eventos que no se detienen son solo de un lazo específico o de ambos?",
                type: "question",
                options: [
                    { label: "Solo del Lazo 1", next: "troubles_lazo1" },
                    { label: "Solo del Lazo 2", next: "troubles_lazo2" },
                    { label: "De ambos lazos", next: "troubles_ambos_lazos" }
                ]
            },

            troubles_lazo1: {
                title: "Procedimiento Lazo 1",
                question: "Desconecte el Lazo 1, reinicie la ILI y espere 2 minutos. ¿Los troubles se detuvieron?",
                type: "question",
                options: [
                    { label: "Sí, se detuvieron", next: "troubles_lazo1_corto" },
                    { label: "No, siguen apareciendo", next: "troubles_probar_lazo2" }
                ]
            },

            troubles_lazo1_corto: {
                title: "Corto en Lazo 1",
                type: "diagnosis",
                status: "bad",
                result: "PROBLEMA: Corto en el Lazo 1. Se requiere revisar todo el cableado y dispositivos del Lazo 1."
            },

            troubles_probar_lazo2: {
                title: "Extender Prueba al Lazo 2",
                question: "Ahora desconecte también el Lazo 2, reinicie y espere. ¿Los troubles se detuvieron?",
                type: "question",
                options: [
                    { label: "Sí, se detuvieron", next: "troubles_lazo2_corto" },
                    { label: "No, siguen apareciendo", next: "troubles_ili_defectuosa" }
                ]
            },

            troubles_lazo2: {
                title: "Procedimiento Lazo 2",
                question: "Desconecte el Lazo 2, reinicie la ILI y espere 2 minutos. ¿Los troubles se detuvieron?",
                type: "question",
                options: [
                    { label: "Sí, se detuvieron", next: "troubles_lazo2_corto" },
                    { label: "No, siguen apareciendo", next: "troubles_probar_lazo1" }
                ]
            },

            troubles_lazo2_corto: {
                title: "Corto en Lazo 2",
                type: "diagnosis",
                status: "bad",
                result: "PROBLEMA: Corto en el Lazo 2. Se requiere revisar todo el cableado y dispositivos del Lazo 2."
            },

            troubles_probar_lazo1: {
                title: "Extender Prueba al Lazo 1",
                question: "Ahora desconecte también el Lazo 1, reinicie y espere. ¿Los troubles se detuvieron?",
                type: "question",
                options: [
                    { label: "Sí, se detuvieron", next: "troubles_lazo1_corto" },
                    { label: "No, siguen apareciendo", next: "troubles_ili_defectuosa" }
                ]
            },

            troubles_ambos_lazos: {
                title: "Procedimiento para Ambos Lazos",
                question: "Desconecte ambos lazos (1 y 2), reinicie la ILI y espere 2 minutos. ¿Los troubles se detuvieron?",
                type: "question",
                options: [
                    { label: "Sí, se detuvieron", next: "troubles_ambos_lazos_corto" },
                    { label: "No, siguen apareciendo", next: "troubles_ili_defectuosa" }
                ]
            },

            troubles_ambos_lazos_corto: {
                title: "Cortos en Ambos Lazos",
                type: "diagnosis",
                status: "bad",
                result: "PROBLEMA: Cortos en ambos lazos. Se requiere revisar cableado y dispositivos de los dos lazos por separado."
            },

            troubles_ili_defectuosa: {
                title: "ILI Defectuosa",
                type: "diagnosis",
                status: "bad",
                result: "PROBLEMA: La ILI envía fallas aleatorias sin parar aún con lazos desconectados.\n\nPROCEDIMIENTO:\n1. Recargar el firmware de la ILI\n2. Recargar la configuración\n3. Repetir las pruebas anteriores\n\nSI NADA DE ESTO DA RESULTADO: La ILI está defectuosa y debe reemplazarse."
            },

            ili_system_normal: {
                title: "Revisión de Historial",
                type: "diagnosis",
                status: "good",
                result: "ACCIÓN REQUERIDA: El sistema está en estado Normal. Es necesario ingresar al Menú y revisar el HISTORIAL (History Log) para identificar qué dispositivo activó la alarma reportada previamente por el cliente."
            },

            ili_leds_no: {
                title: "Revisión de Fuente PM-9",
                question: "Verificar fuente PM-9. ¿La fuente PM-9 está encendida?",
                type: "question",
                options: [
                    { label: "Sí, PM-9 enciende", next: "pm9_si" },
                    { label: "No, PM-9 apagada", next: "pm9_no" }
                ]
            },
            
            pm9_check: { 
                title: "Diagnóstico PM-9",
                question: "¿La fuente PM-9 enciende sus indicadores?",
                type: "question",
                options: [
                    { label: "Sí", next: "pm9_si" },
                    { label: "No", next: "pm9_no" }
                ]
            },
            
            pm9_no: {
                title: "Falla de Alimentación",
                type: "diagnosis",
                status: "bad",
                result: "PROBLEMA: Sin alimentación en la fuente. Verificar entrada AC o reemplazar fuente PM-9."
            },

            // ... (otros pasos existentes se mantienen igual)
            gf_start: {
                title: "Configuración W9",
                question: "Verifique Dipswitch W9. ¿Está en 'Disb'?",
                type: "question",
                options: [{ label: "Sí", next: "gf_check_grounds" }, { label: "No", next: "gf_fix_w9" }]
            },
            gf_fix_w9: { title: "Corrección W9", type: "diagnosis", status: "good", result: "SOLUCIÓN: Poner W9 en 'Disb' para eliminar tierra falsa." },
            gf_check_grounds: {
                title: "Revisión Tierras",
                question: "Revise puestas a tierra (ILI, LCD, RPT). ¿Correctas?",
                type: "question",
                options: [{ label: "Sí", next: "gf_iso_loops" }, { label: "No", next: "gf_fix_grounds" }]
            },
            gf_fix_grounds: { title: "Corrección Tierras", type: "diagnosis", status: "good", result: "SOLUCIÓN: Corregir tierras físicas." },

            reconoce_no: {
                title: "Voltaje Lazo",
                question: "Medir voltaje Lazo 1 y 2. ¿Está entre 18V y 22V?",
                type: "question",
                options: [{ label: "Sí", next: "test_dev_one" }, { label: "No", next: "loop_volt_bad" }]
            },
            loop_volt_bad: { title: "Salida Lazo Mala", type: "diagnosis", status: "bad", result: "PROBLEMA: Salida de voltaje de lazo dañada." },

            rpt_check_leds: {
                title: "Estado de RPT",
                question: "ADVERTENCIA: NUNCA desconecte RPT con ILI encendida.\n\n¿Los LEDs de la RPT están encendidos?",
                warning: true,
                type: "question",
                options: [{ label: "Sí, encendidos", next: "rpt_comms_check" }, { label: "No, apagados", next: "rpt_dead" }]
            },
            rpt_dead: { title: "RPT Dañada", type: "diagnosis", status: "bad", result: "PROBLEMA: Tarjeta RPT dañada. Reemplazar." },
        };

        function render() {
            const step = steps[currentStep];
            const contentArea = document.getElementById('contentArea');
            const navButtons = document.getElementById('navButtons');
            const exportSection = document.getElementById('exportSection');
            
            document.getElementById('stepCounter').textContent = `Paso ${history.length}`;
            let progress = Math.min(history.length * 8, 100);
            document.getElementById('progressFill').style.width = `${progress}%`;

            let html = '';
            
            let icon = step.type === 'diagnosis' 
                ? (step.status === 'good' 
                    ? '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
                    : '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>')
                : '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>';

            html += `<div class="step-title">${icon}<h2>${step.title}</h2></div>`;

            if (step.warning) {
                html += `
                    <div class="warning-note">
                        <svg style="flex-shrink:0" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        <span>ADVERTENCIA: Riesgo de daño de hardware. Lea atentamente.</span>
                    </div>
                `;
            }

            if (step.type === 'question') {
                html += `<div class="question-box"><p>${step.question.replace(/\n/g, '<br>')}</p></div>`;
                html += `<div class="options">`;
                step.options.forEach(opt => {
                    let btnClass = 'btn-neutral';
                    const label = opt.label.toLowerCase();
                    if (label.includes('sí') || label.includes('si,') || label.includes('funciona') || label.includes('desaparece') || label.includes('encendidos') || label.includes('volver') || label.includes('normal')) btnClass = 'btn-yes';
                    if (label.startsWith('no') || label.includes('sigue') || label.includes('apagado') || label.includes('falla') || label.includes('muerta')) btnClass = 'btn-no';
                    
                    html += `<button class="btn ${btnClass}" onclick="selectOption('${opt.next}', '${opt.label}')"><span>${opt.label}</span><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>`;
                });
                html += `</div>`;
            } else {
                const diagClass = step.status === 'good' ? 'diagnosis-good' : 'diagnosis-bad';
                html += `<div class="diagnosis-box ${diagClass}"><h3>Resultado</h3><p>${step.result}</p><span class="take-photo">TOMAR FOTO</span></div>`;
                
                canExport = true;
                exportSection.style.display = 'block';
                logAction('DIAGNOSTICO_FINAL', step.result);
            }

            contentArea.innerHTML = html;

            let navHtml = '';
            if (history.length > 1) {
                navHtml += `<button class="btn-nav btn-back" onclick="goBack()">← Anterior</button>`;
            }
            
            navHtml += `<button class="btn-nav btn-reset" onclick="confirmReset()">Reiniciar ↻</button>`;
            navButtons.innerHTML = navHtml;

            document.getElementById('historyTags').innerHTML = history.map(stepId => 
                `<span class="history-tag">${steps[stepId].title}</span>`
            ).join('');
        }

        function selectOption(nextStep, choiceLabel) {
            logAction('USER_SELECTION', choiceLabel);
            
            history.push(nextStep);
            currentStep = nextStep;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goBack() {
            if (history.length > 1) {
                logAction('GO_BACK', `Volvió de ${steps[currentStep].title} a ${steps[history[history.length-2]].title}`);
                
                history.pop();
                currentStep = history[history.length - 1];
                render();
            }
        }

        function confirmReset() {
            if (confirm("ADVERTENCIA: ¿Está seguro de reiniciar? PERDERÁ todo el registro de auditoría y no podrá exportar el reporte.")) {
                reset();
            }
        }

        function reset() {
            currentStep = 'inicio';
            history = ['inicio'];
            auditLog = [];
            canExport = false;
            document.getElementById('exportSection').style.display = 'none';
            document.getElementById('techName').value = '';
            render();
            
            logAction('SYSTEM_RESET', 'Usuario reinició el diagnóstico');
        }

        function exportToPDF() {
            const techName = document.getElementById('techName').value.trim();
            
            if (!techName) {
                alert('DEBE ingresar su nombre completo para generar el reporte de auditoría.');
                document.getElementById('techName').focus();
                document.getElementById('techName').style.borderColor = '#dc2626';
                return;
            }
            
            if (!canExport) {
                alert('No puede exportar el reporte hasta completar un diagnóstico final.');
                return;
            }
            
            document.getElementById('techName').style.borderColor = '#e2e8f0';
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            let yPos = margin;
            
            // Título principal - SIN EMOJIS
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("MDM SECURITIES INC", pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 10;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("REPORTE DE DIAGNÓSTICO TÉCNICO", pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 15;
            doc.setFontSize(10);
            doc.text(`Técnico: ${techName}`, margin, yPos);
            doc.text(`Fecha: ${new Date().toLocaleString('es-ES')}`, pageWidth - margin, yPos, { align: 'right' });
            
            yPos += 10;
            doc.text(`ID de Sesión: ${Date.now().toString().substring(7, 13)}`, margin, yPos);
            
            yPos += 15;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("REGISTRO COMPLETO", margin, yPos);
            
            yPos += 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            const relevantLogs = auditLog.filter(log => 
                log.action === 'USER_SELECTION' || 
                log.action === 'DIAGNOSTICO_FINAL'
            );
            
            let startY = yPos + 10;
            
            // Dibujar cabecera - SIN EMOJIS
            doc.setFillColor(59, 130, 246);
            doc.setTextColor(255, 255, 255);
            doc.rect(margin, startY, pageWidth - 2*margin, 10, 'F');
            
            doc.setFont("helvetica", "bold");
            doc.text("Hora", margin + 5, startY + 7);
            doc.text("Paso", margin + 30, startY + 7);
            doc.text("Elección", margin + 110, startY + 7);
            
            startY += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            
            relevantLogs.forEach((log, index) => {
                if (startY > 270) {
                    doc.addPage();
                    startY = margin;
                }
                
                if (index % 2 === 0) {
                    doc.setFillColor(241, 245, 249);
                    doc.rect(margin, startY, pageWidth - 2*margin, 10, 'F');
                }
                
                const choice = log.action === 'DIAGNOSTICO_FINAL' 
                    ? 'DIAGNÓSTICO FINAL' 
                    : (log.userChoice || '');
                
                // Columna 1: Hora
                doc.text(log.timestamp, margin + 5, startY + 7);
                
                // Columna 2: Paso
                const stepTitle = log.stepTitle.length > 35 ? log.stepTitle.substring(0, 32) + '...' : log.stepTitle;
                doc.text(stepTitle, margin + 30, startY + 7);
                
                // Columna 3: Elección
                const choiceText = choice.length > 40 ? choice.substring(0, 37) + '...' : choice;
                
                if (choice.toLowerCase().includes('sí') || choice.toLowerCase().includes('si') || 
                    choice.toLowerCase().includes('correcto') || choice.toLowerCase().includes('funciona')) {
                    doc.setTextColor(22, 163, 74);
                } else if (choice.toLowerCase().startsWith('no') || choice.toLowerCase().includes('sigue') || 
                          choice.toLowerCase().includes('falla') || choice.toLowerCase().includes('muerta')) {
                    doc.setTextColor(220, 38, 38);
                } else if (choice === 'DIAGNÓSTICO FINAL') {
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "bold");
                }
                
                doc.text(choiceText, margin + 110, startY + 7);
                
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");
                
                startY += 10;
            });
            
            startY += 10;
            
            // Resumen final - SIN EMOJIS
            if (startY > 250) {
                doc.addPage();
                startY = margin;
            }
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("RESUMEN", margin, startY);
            
            startY += 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            const totalSteps = relevantLogs.filter(log => log.action === 'USER_SELECTION').length;
            const diagnosis = relevantLogs.find(log => log.action === 'DIAGNOSTICO_FINAL');
            
            doc.text(`• Total de pasos realizados: ${totalSteps}`, margin, startY);
            startY += 7;
            doc.text(`• Hora de inicio: ${auditLog[0]?.timestamp || 'N/A'}`, margin, startY);
            startY += 7;
            doc.text(`• Hora de finalización: ${new Date().toLocaleTimeString('es-ES')}`, margin, startY);
            
            if (diagnosis) {
                startY += 10;
                doc.setFont("helvetica", "bold");
                doc.text("DIAGNÓSTICO FINAL:", margin, startY);
                startY += 7;
                doc.setFont("helvetica", "normal");
                
                const diagnosisText = diagnosis.details.replace(/\n/g, ' ');
                const diagnosisLines = doc.splitTextToSize(diagnosisText, pageWidth - 2*margin);
                
                diagnosisLines.forEach(line => {
                    if (startY > 270) {
                        doc.addPage();
                        startY = margin;
                    }
                    doc.text(line, margin, startY);
                    startY += 7;
                });
            }
            
            startY += 10;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            
            const signature = `Firma: ${techName.substring(0, 3).toUpperCase()}${Date.now().toString().substring(9, 13)}`;
            doc.text("Reporte generado automáticamente por Sistema de Diagnóstico Gamewell-FCI v3.2", pageWidth / 2, startY, { align: 'center' });
            startY += 5;
            doc.text(signature, pageWidth / 2, startY, { align: 'center' });
            
            const safeName = techName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
            const fileName = `Diagnostico_${safeName}_${new Date().toISOString().slice(0,10)}.pdf`;
            
            doc.save(fileName);
            
            alert(`Reporte generado exitosamente.\n\nArchivo: ${fileName}\n\nEste registro contiene ${relevantLogs.length} pasos documentados.`);
        }

        render();
        logAction('SESSION_START', 'Inició diagnóstico');
    </script>
</body>
</html>
